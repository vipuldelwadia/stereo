<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
        "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
<head>
<title>Stereo</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<script type="text/javascript" charset="utf-8">
//<![CDATA[
	function getPlaybackStatusUpdate() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				parseUpdateResponse(request);
			}
		};
		if (lastUpdate && lastUpdate.revision) {
			request.open("GET", "/ctrl-int/1/playstatusupdate?revision-number="+lastUpdate.revision, true);
		}
		else {
			request.open("GET", "/ctrl-int/1/playstatusupdate", true);
		}
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getPlaylistUpdate() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				parsePlaylistResponse(request);
			}
		};
		request.open("GET", "/ctrl-int/1/playlist", true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getAlbumArt(revision) {
		document.getElementById("albumart").src = "/ctrl-int/1/nowplayingartwork?revision="+revision;
	}

	function getPlaylists() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				var text = request.responseText;

				var tree = new Node();
				parseNode(tree, text, 0);
				tree = tree.children[0];

				var playlists = new Array();
				
				for (node in tree.children) {
					if (tree.children[node].name = "mlcl") {
						var list = tree.children[node];
						for (item in list.children) {
							playlists.push(new Container(list.children[item]));
						}
					} 
				}

				var parent = document.getElementById("browse-playlists-container");
				while (parent.childNodes.length > 0) {
					parent.removeChild(parent.firstChild);
				}
				
				for (p in playlists) {
					var item = document.createElement("DIV");
					item.className="item";
					
					item.appendChild(createNode("title", playlists[p].name));
					item.appendChild(createNode("count", playlists[p].items));
					
					parent.appendChild(item);
				}
			}
		};
		request.open("GET", "/databases/1/containers", true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getArtists() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				var text = request.responseText;

				var tree = new Node();
				parseNode(tree, text, 0);
				tree = tree.children[0];
				
				var artists = new Array();
				
				for (node in tree.children) {
					if (tree.children[node].name = "abar") {
						var list = tree.children[node];
						for (item in list.children) {
							artists.push(list.children[item].value);
						}
					} 
				}

				var parent = document.getElementById("browse-artists-container");
				
				while (parent.childNodes.length > 0) {
					parent.removeChild(parent.firstChild);
				}

				for (a in artists) {
					var item = document.createElement("DIV");
					item.className="item";
					item.query="'daap.songartist:"+artists[a]+"'";
					
					item.appendChild(createNode("title", artists[a]));
					
					parent.appendChild(item);
				}
			}
		};
		request.open("GET", "/databases/1/browse/artists", true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getAlbums(query, callback) {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				var text = request.responseText;

				var tree = new Node();
				parseNode(tree, text, 0);
				tree = tree.children[0];

				var albums = new Array();
				
				for (node in tree.children) {
					if (tree.children[node].name = "mlcl") {
						var list = tree.children[node];
						for (item in list.children) {
							albums.push(new Album(list.children[item]));
						}
					} 
				}

				callback(albums);
			}
		};

		request.open("GET", "/databases/1/groups?group-type=albums&sort=albums&query="+query, true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getTracks(query, callback) {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				var text = request.responseText;

				var tree = new Node();
				parseNode(tree, text, 0);
				tree = tree.children[0];
				
				var tracks = new Array();
				
				for (node in tree.children) {
					if (tree.children[node].name = "mlcl") {
						var list = tree.children[node];
						for (item in list.children) {
							tracks.push(new Track(list.children[item]));
						}
					} 
				}

				callback(tracks);
			}
		};

		request.open("GET", "/databases/1/containers/1/items?query="+query, true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function next() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/nextitem", true);
		request.send(null);
	}

	function prev() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/previtem", true);
		request.send(null);
	}

	function play() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/playpause", true);
		request.send(null);
	}

	function pause() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/pause", true);
		request.send(null);
	}

	function jump(index) {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/cue?command=play&index="+index);
		request.send(null);
	}

	function Node(name, length) {
		this.name = name;
		this.length = length;
		this.value = "";
		this.children = new Array();
		this.print = function (indent) {
			sysout(indent + this.name + ": " + this.value + " (" + this.length + ")");
			for (var i = 0; i < this.children.length; i++) {
				this.children[i].print(indent+"  ");
			}
		}
	}
	
	function parseUpdateResponse(response) {
		var text = response.responseText;

		var name = text.substring(0, 4);
		var length = parseInt(text, 4);
		
		var tree = new Node(name, length);
		
		for (var i = 8; i < text.length;) {
			i += parseNode(tree, text, i);
		}

		var up = new PlayStatusUpdate(tree);

		updateStatus(up);

		if (!lastUpdate || up.revision != lastUpdate.revision) {
			getPlaylistUpdate();
			getAlbumArt(up.revision);
			if ((!lastUpdate && up.status == 4)
				|| (lastUpdate.status == 2 && up.status == 4)) {
					document.body.className = "playing";
			}
		}

		lastUpdate = up;
		getPlaybackStatusUpdate();
	}

	function parsePlaylistResponse(response) {
		var text = response.responseText;

		var name = text.substring(0, 4);
		var length = parseInt(text, 4);
		
		var tree = new Node(name, length);
		
		for (var i = 8; i < text.length;) {
			i += parseNode(tree, text, i);
		}

		var playlist = new Playlist(tree);

		updatePlaylist(playlist);
	}


	function parseNode(parent, text, index, debug) {
		var name = text.substring(index, index + 4);
		var length = parseInt(text, index + 4);
		var node = new Node(name, length);

		if (debug) sysout(name + " " + length);
		
		if (name == "mlit" && parent.name == "abar") {
			//this is a hack caused by apple reusing mlit (list)
			//as a string container in abar records
			node.value = parseString(text, index+8, length);
		}
		else {
			switch (types[name]) {
			case byteVal:
				node.value = parseByte(text, index + 8);
				break;
			case shortVal:
				node.value = parseShort(text, index + 8);
				break;
			case intVal:
				node.value = parseInt(text, index + 8);
				break;
			case longVal:
				node.value = parseLong(text, index + 8);
				break;
			case longlongVal:
				node.value = parseLongLong(text, index + 8);
				break;
			case stringVal:
				node.value = parseString(text, index + 8, length);
				break;
			case dateVal:
				node.value = parseDate(text, index + 8);
				break;
			case version:
				node.value = parseVersion(text, index + 8);
				break;
			case list:
				for ( var i = 0; i < length;) {
					i += parseNode(node, text, 8 + index + i);
				}
				break;
			}
		}

		parent.children.push(node);
		return 8 + length;
	}

	function parseByte(text, index) {
		return text.charCodeAt(index);
	}

	function parseShort(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		return i;
	}

	function parseInt(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 2) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 3) & 255;
		return i;
	}

	function parseLong(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 2) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 3) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 4) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 5) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 6) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 7) & 255;
		return i;
	}

	function parseLongLong(text, index) {
		var i = new Array();
		i.push(parseInt(text, index));
		i.push(parseInt(text, index + 4));
		i.push(parseInt(text, index + 8));
		i.push(parseInt(text, index + 12));
		return i;
	}

	function parseString(text, index, length) {
		//needs to decode utf-8. This is slow :-(

		var string = "";

		for ( var i = 0; i < length;) {
			var c = text.charCodeAt(index + i) & 255;
			if (c < 128) {
				string += String.fromCharCode(c);
				i++;
			} else if (c > 191 && c < 224) {
				var c2 = text.charCodeAt(index + i + 1) & 255;
				string += String.fromCharCode(((c & 31)) << 6 | (c2 & 63));
				i += 2;
			} else {
				var c2 = text.charCodeAt(index + i + 1) & 255;
				var c3 = text.charCodeAt(index + i + 2) & 255;
				string += String.fromCharCode(((c & 15)) << 12 | (c2 & 63) << 6
						| (c3 & 63));
				i += 3;
			}
		}

		return string;
	}

	function parseDate(text, index) {
		return parseInt(text, index);
	}

	function parseVersion(text, index) {
		var i = text.charCodeAt(index) & 255;
		i += ".";
		i += text.charCodeAt(index + 1) & 255;
		i += ".";
		i += text.charCodeAt(index + 2) & 255;
		i += ".";
		i += text.charCodeAt(index + 3) & 255;
		return i;
	}

	function sysout(text) {
		var p = document.createElement("PRE");
		p.className = "debug";
		p.appendChild(document.createTextNode(text));
		document.body.appendChild(p);
	}

	var lastUpdate = 0;
	var previousPane = new Array();

	function PlayStatusUpdate(tree) {

		this.album = "";
		this.title = "";
		this.artist = "";
		this.genre = "";
		this.id = 0;
		this.status = 0;
		this.revision = 0;

		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "caps":
				this.status = node.value;
				break;
			case "cmsr":
				this.revision = node.value;
				break;
			case "cann":
				this.title = node.value;
				break;
			case "cana":
				this.artist = node.value;
				break;
			case "canl":
				this.album = node.value;
				break;
			case "cang":
				this.genre = node.value;
				break;
			case "canp":
				this.id = node.value[3];
				break;
			}
		}
	}

	function Container(tree) {
		this.id = 0;
		this.persistantId = 0;
		this.name = "";
		this.base = false;
		this.parent = 0;
		this.items = 0;

		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "miid":
				this.id = node.value;
				break;
			case "mper":
				this.persistantId = node.value;
				break;
			case "minm":
				this.name = node.value;
				break;
			case "abpl":
				this.base = node.value;
				break;
			case "mpco":
				this.parent = node.value;
				break;
			case "mimc":
				this.items = node.value;
				break;
			}
		}
	}

	function Playlist(tree) {

		this.tracks = new Array();

		var list = 0;

		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "mlcl":
				list = node;
				break;
			}
		}

		if (!list)
			return;

		for (child in list.children) {
			var node = list.children[child];
			switch (node.name) {
			case "mlit":
				this.tracks.push(new Track(node));
				break;
			}
		}
	}

	function Album(tree) {

		this.id = 0;
		this.name = "";
		this.artist = 0;
		this.persistantId = 0;

		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "miid":
				this.id = node.value;
				break;
			case "minm":
				this.name = node.value;
				break;
			case "asaa":
				this.artist = node.value;
				break;
			case "mper":
				this.persistantId = node.value;
				break;
			}
		}
	}

	function Track(tree) {

		this.album = "";
		this.title = "";
		this.artist = "";
		this.genre = "";
		this.id = 0;

		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "asal":
				this.album = node.value;
				break;
			case "minm":
				this.title = node.value;
				break;
			case "asar":
				this.artist = node.value;
				break;
			case "asag":
				this.genre = node.value;
				break;
			case "miid":
				this.id = node.value;
				break;
			}
		}
	}

	function updateStatus(update) {

		if (update.status == 2) {
			document.getElementById("state").className = "stopped";

			document.getElementById("play").className = "";
			document.getElementById("pause").className = "hidden";
		} else if (update.status == 3) {
			document.getElementById("state").className = "paused";
			setText(document.getElementById("title"), update.title);
			setText(document.getElementById("artist"), update.artist);
			setText(document.getElementById("album"), update.album);
			setText(document.getElementById("genre"), update.genre);

			document.getElementById("play").className = "";
			document.getElementById("pause").className = "hidden";
		} else if (update.status == 4) {
			document.getElementById("state").className = "playing";
			setText(document.getElementById("title"), update.title);
			setText(document.getElementById("artist"), update.artist);
			setText(document.getElementById("album"), update.album);
			setText(document.getElementById("genre"), update.genre);

			document.getElementById("play").className = "hidden";
			document.getElementById("pause").className = "";
		}
	}

	function setText(node, text) {
		while (node.childNodes.length > 0) {
			node.removeChild(node.firstChild);
		}
		node.appendChild(document.createTextNode(text));
	}

	function updatePlaylist(playlist) {

		var list = document.getElementById("playlist");
		list.innerHTML = "";

		var current = lastUpdate.id;

		for (i in playlist.tracks) {
			var track = playlist.tracks[i];

			var node = document.createElement("DIV");
			node.className = "item";

			node.appendChild(createNode("album", track.album));
			node.appendChild(createNode("title", track.title));
			node.appendChild(createNode("artist", track.artist));
			node.appendChild(createNode("genre", track.genre));
			node.appendChild(createNode("id", track.id));

			if (current && track.id == current) {
				node.className += " current";
				current = 0;

				while (list.childNodes.length > 2) {
					list.removeChild(list.childNodes[0]);
				}
			}

			list.appendChild(node);
		}
	}

	function createNode(type, value) {
		var node = document.createElement("DIV");
		node.className = type;
		node.appendChild(document.createTextNode(value));
		return node;
	}

	function registerControls() {

		document.getElementById("back").onclick = function() {
			if (previousPane.length == 0) {
				previousPane.push("playlists");
			}
			document.body.className = previousPane.pop();
		}
		document.getElementById("playing").onclick = function() {
			if (document.body.className) {
				previousPane.push(document.body.className);
			}
			document.body.className = "playing";
		}

		document.body.className = "playlists";

		document.getElementById("previous").onclick = function() {
			prev();
		}
		document.getElementById("play").onclick = function() {
			play();
		}
		document.getElementById("pause").onclick = function() {
			pause();
		}
		document.getElementById("next").onclick = function() {
			next();
		}

		document.getElementById("playlist").onclick = function(e) {
			var node = e.target;
			while (!node.className.match("item")) {
				node = node.parentNode;
				if (node == document.body)
					return;
			}
			var playlist = document.getElementById("playlist");
			var offset = -1;
			for (child in playlist.childNodes) {
				if (playlist.childNodes[child].className
						&& playlist.childNodes[child].className
								.match("current")) {
					offset = child;
				}
			}
			if (offset == -1)
				return;
			for (child in playlist.childNodes) {
				if (playlist.childNodes[child] == node) {
					jump(child - offset);
					break;
				}
			}
		}

		document.getElementById("browse-artists-container").onclick = function(e) {
			var node = e.target;
			while (!node.className.match("item")) {
				node = node.parentNode;
				if (node == document.body)
					return;
			}
			
			var query = node.query;
			
			getAlbums(query, function (albums) {
				var parent = document.getElementById("browse-artists-albums");
				while (parent.childNodes.length > 0) {
					parent.removeChild(parent.firstChild);
				}
				for (a in albums) {
					var item = document.createElement("DIV");
					item.className="item";
					item.query="'daap.songalbum="+albums[a].name+"'";
				
					item.appendChild(createNode("title", albums[a].name));
				
					parent.appendChild(item);
				}
				previousPane.push("artists");
				document.body.className = "artist-albums";
			});
		}

		document.getElementById("browse-artists-albums").onclick = function(e) {
			var node = e.target;
			while (!node.className.match("item")) {
				node = node.parentNode;
				if (node == document.body)
					return;
			}
			var query = "'daap.songalbum:"+node.textContent+"'";
			getTracks(query, function (tracks) {
				var parent = document.getElementById("browse-artists-tracks");
				while (parent.childNodes.length > 0) {
					parent.removeChild(parent.firstChild);
				}
				for (t in tracks) {
					var item = document.createElement("DIV");
					item.className="item";
				
					item.appendChild(createNode("title", tracks[t].title));
				
					parent.appendChild(item);
				}
				previousPane.push("artist-albums");
				document.body.className = "artist-tracks";
			});
		}

		document.getElementById("browse-albums-container").onclick = function(e) {
			var node = e.target;
			while (!node.className.match("item")) {
				node = node.parentNode;
				if (node == document.body)
					return;
			}
			
			var query = node.query;
			
			getTracks(query, function (tracks) {
				var parent = document.getElementById("browse-albums-tracks");
				while (parent.childNodes.length > 0) {
					parent.removeChild(parent.firstChild);
				}
				for (t in tracks) {
					var item = document.createElement("DIV");
					item.className="item";
				
					item.appendChild(createNode("title", tracks[t].title));
				
					parent.appendChild(item);
				}
				previousPane.push("albums");
				document.body.className = "album-tracks";
			});
		}

		replacePrev();
		replacePause();
		replacePlay();
		replaceNext();

		document.getElementById("browse-menu-playlists").onclick = function() {
			getPlaylists();
			document.body.className = "playlists";
		}
		document.getElementById("browse-menu-artists").onclick = function() {
			getArtists();
			document.body.className = "artists";
		}
		document.getElementById("browse-menu-albums").onclick = function() {
			getAlbums("'daap.songalbum!:'", function (albums) {
					var parent = document.getElementById("browse-albums-container");
					while (parent.childNodes.length > 0) {
						parent.removeChild(parent.firstChild);
					}
					for (a in albums) {
						var item = document.createElement("DIV");
						item.className="item";
						item.query="'daap.songalbum:"+albums[a].name+"'";
					
						item.appendChild(createNode("title", albums[a].name));
					
						parent.appendChild(item);
					}
					document.body.className = "albums";
			});
		}
		document.getElementById("browse-menu-search").onclick = function() {
			getSearch();
			document.body.className = "search";
		}
		getPlaylists();
		document.body.className = "playlists";
	}

	function replacePrev() {
		var prev = document.getElementById("previous");
		prev.removeChild(prev.firstChild);

		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 33, 30');
		svg.setAttribute('width', '33');
		svg.setAttribute('height', '30');

		var bar = document.createElementNS(ns, 'path');
		bar.setAttribute('d', 'm 0,3 4,0 0,24 -4,0 z');
		bar.setAttribute('style', 'fill: #222;');
		svg.appendChild(bar);

		var la = document.createElementNS(ns, 'path');
		la.setAttribute('d', 'm 7,15 10,11 0,-22 z');
		la
				.setAttribute('style',
						'fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(la);

		var ra = document.createElementNS(ns, 'path');
		ra.setAttribute('d', 'm 20,15 10,11 0,-22 z');
		ra
				.setAttribute('style',
						'fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(ra);

		prev.appendChild(svg);
	}

	function replacePlay() {
		var play = document.getElementById("play");
		play.removeChild(play.firstChild);

		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 30, 30');
		svg.setAttribute('width', '30');
		svg.setAttribute('height', '30');

		var p = document.createElementNS(ns, 'path');
		p.setAttribute('d', 'm 5,3 22,12 -22,12 z');
		p
				.setAttribute('style',
						'fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(p);

		play.appendChild(svg);
	}

	function replacePause() {
		var pause = document.getElementById("pause");
		pause.removeChild(pause.firstChild);

		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 17, 30');
		svg.setAttribute('width', '30');
		svg.setAttribute('height', '30');

		var l = document.createElementNS(ns, 'path');
		l.setAttribute('d', 'm 0,2 6,0 0,26 -6,0 z');
		l.setAttribute('style', 'fill: #222;');
		svg.appendChild(l);

		var r = document.createElementNS(ns, 'path');
		r.setAttribute('d', 'm 11,2 6,0 0,26 -6,0 z');
		r.setAttribute('style', 'fill: #222;');
		svg.appendChild(r);

		pause.appendChild(svg);
	}

	function replaceNext() {
		var next = document.getElementById("next");
		next.removeChild(next.firstChild);

		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 33, 30');
		svg.setAttribute('width', '33');
		svg.setAttribute('height', '30');

		var la = document.createElementNS(ns, 'path');
		la.setAttribute('d', 'm 1,4 10,11 -10,11 z');
		la
				.setAttribute('style',
						'fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(la);

		var ra = document.createElementNS(ns, 'path');
		ra.setAttribute('d', 'm 15,4 10,11 -10,11 z');
		ra
				.setAttribute('style',
						'fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(ra);

		var bar = document.createElementNS(ns, 'path');
		bar.setAttribute('d', 'm 27,3 4,0 0,24 -4,0 z');
		bar.setAttribute('style', 'fill: #222;');
		svg.appendChild(bar);

		next.appendChild(svg);
	}
	//]]>
</script>

<script type="text/javascript" charset="utf-8">
//<![CDATA[
	var byteVal = 1;
	var shortVal = 3;
	var intVal = 5;
	var longVal = 7;
	var longlongVal = 8;
	var stringVal = 9;
	var dateVal = 10; //4-byte int
	var version = 11; //4 single bytes or two ints
	var list = 12;
	var composite = 13;
	var types = new Array();
	types["cmst"] = list;
	types["mstt"] = intVal;
	types["cmsr"] = intVal;
	types["caps"] = byteVal;
	types["cash"] = byteVal;
	types["carp"] = byteVal;
	types["caas"] = intVal;
	types["caar"] = intVal;
	types["canp"] = longlongVal;
	types["cann"] = stringVal;
	types["cana"] = stringVal;
	types["canl"] = stringVal;
	types["cang"] = stringVal;
	types["asai"] = longVal;
	types["cmmk"] = intVal;
	types["cant"] = intVal;
	types["cast"] = intVal;

	types["muty"] = intVal;
	types["mtco"] = intVal;
	types["mrco"] = intVal;
	types["mlcl"] = list;
	types["mlit"] = list;
	types["minm"] = stringVal;
	types["asgn"] = stringVal;
	types["asal"] = stringVal;
	types["asar"] = stringVal;
	types["mikd"] = byteVal;
	types["assp"] = intVal;
	types["assr"] = intVal;
	types["asst"] = intVal;
	types["astm"] = intVal;
	types["asai"] = longVal;
	types["miid"] = intVal;

	types["aply"] = list;
	types["abpl"] = byteVal;
	types["mpco"] = intVal;
	types["mimc"] = intVal;
	types["mper"] = longVal;

	types["abro"] = list;
	types["abar"] = list;

	types["agal"] = list;
	types["apso"] = list;
	
	//]]>
</script>

<style type="text/css">
html, body {
	margin: 0;
}
body {
	font-family: "Geneva", sans-serif;
}
#navigation {
	position: fixed;
	top: 0;
	height: 4ex;
	left: 0;
	right: 0;
	background-color: #ccc;
	color: black;
}
#navigation div {
	font-size: 80%;
	padding: 1ex 1em;
}
.playing #navigation {
	background-color: #222;
	color: white;
}
.playing #playing {
	display: none;
}
.playlists #back, .albums #back, .artists #back, .search #back {
	display: none;
}
#back {
	float: left;
}
#playing {
	float: right;
}
.content {
	margin-top: 4ex;
	margin-bottom: 8ex;
}
#playlist {
	margin-top: 18ex;
}
#state {
	position: fixed;
	top: 4ex;
	height: 10ex;
	left: 0;
	right: 0;
	padding: 2ex 1em;
	padding-bottom: 2ex;
	border-bottom: solid 2px #ccc;
	background: white;
	overflow: auto;
}
#state div {
	font-size: 120%;
}
#state .artist {
	color: black;
}
#state .album,#state .genre {
	font-size: 80%;
}
.item {
	border-bottom: solid 1px #ccc;
	padding: 1ex 1em;
	display: block;
}
.album,.artist,.title {
	display: block;
}
.album, .artist, .genre {
	color: #888;
	font-size: 0.7em;
}
.title {
	font-weight: bold;
}
.id {
	display: none;
}
.current {
	background-color: #eee;
}
#albumart {
	height: 10ex;
	float: left;
	margin-right: 1em;
}
#control {
	position: fixed;
	bottom: 0;
	height: 4ex;
	padding: 2ex 0;
	width: 100%;
	text-align: center;
	opacity: 0.8;
	background-color: #ccc;
}
#control div {
	display: inline;
}
#control .hidden {
	display: none;
}
#control #volume {
	display: none;
}
#play,#pause {
	padding: 2ex 3em;
}
#current {
	display: none;
}
.playing #current {
	display: block;
}
.playing #browse {
	display: none;
}
#browse-menu {
	position: fixed;
	left: 0;
	right: 0;
	bottom: 0;
	height: 4ex;
	padding: 2ex 0;
	background-color: #222;
	color: white;
	text-align: center;
}
#browse-menu div {
	display: inline;
}
.debug {
	display: block;
}
#browse .content {
	display: none;
}
#browse .content .container {
	display: none;
}
.playlists #browse-playlists {
	display: block;
}
.playlists .content #browse-playlists-container {
	display: block;
}
.artists #browse-artists,
.artist-albums #browse-artists,
.artist-tracks #browse-artists {
	display: block;
}
.artists .content #browse-artists-container {
	display: block;
}
.artist-albums .content #browse-artists-albums {
	display: block;
}
.artist-tracks .content #browse-artists-tracks {
	display: block;
}
.albums #browse-albums,
.album-tracks #browse-albums {
	display: block;
}
.albums .content #browse-albums-container {
	display: block;
}
.album-tracks .content #browse-albums-tracks {
	display: block;
}
.search #browse-search {
	display: block;
}
</style>

</head>
<body onload="registerControls(); getPlaybackStatusUpdate();">
<div id="navigation">
	<div id="back">Back</div>
	<div id="playing">Now Playing</div>
</div>
<div id="current">
	<div id="state">
		<img id="albumart" src="" alt="" />
		<div id="title" class="title"></div>
		<div id="album" class="album"></div>
		<div id="artist" class="artist"></div>
		<div id="genre" class="genre"></div>
	</div>
	<div id="control">
		<div id="previous">previous</div>
		<div id="play">play</div>
		<div id="pause">pause</div>
		<div id="next">next</div>
		<div id="volume">volume</div>
	</div>
	<div id="playlist" class="content">
	</div>
</div>
<div id="browse">
	<div id="browse-menu">
		<div id="browse-menu-playlists">Playlists</div>
		<div id="browse-menu-artists">Artists</div>
		<div id="browse-menu-albums">Albums</div>
		<div id="browse-menu-search">Search</div>
	</div>
	<div id="browse-playlists" class="content">
		<div id="browse-playlists-container" class="container"></div>
	</div>
	<div id="browse-artists" class="content">
		<div id="browse-artists-container" class="container"></div>
		<div id="browse-artists-albums" class="container"></div>
		<div id="browse-artists-tracks" class="container"></div>
	</div>
	<div id="browse-albums" class="content">
		<div id="browse-albums-container" class="container"></div>
		<div id="browse-albums-tracks" class="container"></div>
	</div>
	<div id="browse-search" class="content"></div>
</div>
</body>
</html>