<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
        "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
<head>
<title>Stereo</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<script type="text/javascript" charset="utf-8">
//<![CDATA[
	function getPlaybackStatusUpdate() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				parseUpdateResponse(request);
			}
		};
		if (lastUpdate && lastUpdate.revision) {
			request.open("GET", "/ctrl-int/1/playstatusupdate?revision-number="+lastUpdate.revision, true);
		}
		else {
			request.open("GET", "/ctrl-int/1/playstatusupdate", true);
		}
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getPlaylistUpdate() {
		var request = new XMLHttpRequest();
		request.onreadystatechange = function() {
			if (request.readyState == 4) {
				parsePlaylistResponse(request);
			}
		};
		request.open("GET", "/ctrl-int/1/playlist", true);
		//XHR binary charset opt by Marcus Granado 2006 [http://mgran.blogspot.com] 
		request.overrideMimeType('text/plain; charset=x-user-defined');
		request.send(null);
	}

	function getAlbumArt() {
		document.getElementById("albumart").src = "/ctrl-int/1/nowplayingartwork";
	}

	function next() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/nextitem", true);
		request.send(null);
	}

	function prev() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/previtem", true);
		request.send(null);
	}

	function play() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/playpause", true);
		request.send(null);
	}

	function pause() {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/pause", true);
		request.send(null);
	}

	function jump(index) {
		var request = new XMLHttpRequest();
		request.open("GET", "/ctrl-int/1/cue?command=play&index="+index);
		request.send(null);
	}

	function Node(name, length) {
		this.name = name;
		this.length = length;
		this.value = "";
		this.children = new Array();
		this.print = function (indent) {
			sysout(indent + this.name + ": " + this.value + " (" + this.length + ")");
			for (var i = 0; i < this.children.length; i++) {
				this.children[i].print(indent+"&nbsp;&nbsp;");
			}
		}
	}
	
	function parseUpdateResponse(response) {
		var text = response.responseText;

		var name = text.substring(0, 4);
		var length = parseInt(text, 4);
		
		var tree = new Node(name, length);
		
		for (var i = 8; i < text.length;) {
			i += parseNode(tree, text, i);
		}

		var up = new PlayStatusUpdate(tree);

		updateStatus(up);

		if (up.revision != lastUpdate.revision) {
			getPlaylistUpdate();
			getAlbumArt();
		}

		lastUpdate = up;
		getPlaybackStatusUpdate();
	}

	function parsePlaylistResponse(response) {
		var text = response.responseText;

		var name = text.substring(0, 4);
		var length = parseInt(text, 4);
		
		var tree = new Node(name, length);
		
		for (var i = 8; i < text.length;) {
			i += parseNode(tree, text, i);
		}

		//tree.print("");

		var playlist = new Playlist(tree);

		updatePlaylist(playlist);
	}


	function parseNode(parent, text, index) {
		var name = text.substring(index, index + 4);
		var length = parseInt(text, index + 4);
		var node = new Node(name, length);

		switch (types[name]) {
		case byteVal:
			node.value = parseByte(text, index+8); break;
		case shortVal:
			node.value = parseShort(text, index+8); break;
		case intVal:
			node.value = parseInt(text, index+8); break;
		case longVal:
			node.value = parseLong(text, index+8); break;
		case longlongVal:
			node.value = parseLongLong(text, index+8); break;
		case stringVal:
			node.value = parseString(text, index+8, length); break;
		case dateVal:
			node.value = parseDate(text, index+8); break;
		case version:
			node.value = parseVersion(text, index+8); break;
		case list:
			for ( var i = 0; i < length;) {
				i += parseNode(node, text, 8 + index + i);
			}
			break;
		}

		parent.children.push(node);
		return 8 + length;
	}

	function parseByte(text, index) {
		return text.charCodeAt(index);
	}

	function parseShort(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		return i;
	}
	
	function parseInt(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 2) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 3) & 255;
		return i;
	}

	function parseLong(text, index) {
		var i = text.charCodeAt(index) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 1) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 2) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 3) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 4) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 5) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 6) & 255;
		i <<= 8;
		i += text.charCodeAt(index + 7) & 255;
		return i;
	}

	function parseLongLong(text, index) {
		var i = new Array();
		i.push(parseInt(text, index));
		i.push(parseInt(text, index+4));
		i.push(parseInt(text, index+8));
		i.push(parseInt(text, index+12));
		return i;
	}

	function parseString(text, index, length) {
		//needs to decode utf-8. This is slow :-(

		var string = "";

		for (var i = 0; i < length;) {
			var c = text.charCodeAt(index+i) & 255;
			if (c < 128) {
				string += String.fromCharCode(c) ;
				i++;
			}
			else if (c > 191 && c < 224) {
				var c2 = text.charCodeAt(index+i+1) & 255;
				string += String.fromCharCode(((c & 31)) << 6 | (c2 & 63));
				i+=2;
			}
			else {
				var c2 = text.charCodeAt(index+i+1) & 255;
				var c3 = text.charCodeAt(index+i+2) & 255;
				string += String.fromCharCode(((c & 15)) << 12 | (c2 & 63) << 6 | (c3 & 63));
				i+=3;
			}
		}

		return string;
	}

	function parseDate(text, index) {
		return parseInt(text, index);
	}

	function parseVersion(text, index) {
		var i = text.charCodeAt(index) & 255;
		i += ".";
		i += text.charCodeAt(index + 1) & 255;
		i += ".";
		i += text.charCodeAt(index + 2) & 255;
		i += ".";
		i += text.charCodeAt(index + 3) & 255;
		return i;
	}

	function sysout(text) {
		var p = document.createElement("DIV");
		p.innerHTML = text;
		document.body.appendChild(p);
	}

	var byteVal = 1;
	var shortVal = 3;
	var intVal = 5;
	var longVal = 7;
	var longlongVal = 8;
	var stringVal = 9;
	var dateVal = 10; //4-byte int
	var version = 11; //4 single bytes or two ints
	var list = 12;
	var composite = 13;
	var types = new Array();
	types["cmst"] = list;
	types["mstt"] = intVal;
	types["cmsr"] = intVal;
	types["caps"] = byteVal;
	types["cash"] = byteVal;
	types["carp"] = byteVal;
	types["caas"] = intVal;
	types["caar"] = intVal;
	types["canp"] = longlongVal;
	types["cann"] = stringVal;
	types["cana"] = stringVal;
	types["canl"] = stringVal;
	types["cang"] = stringVal;
	types["asai"] = longVal;
	types["cmmk"] = intVal;
	types["cant"] = intVal;
	types["cast"] = intVal;

	types["muty"] = intVal;
	types["mtco"] = intVal;
	types["mrco"] = intVal;
	types["mlcl"] = list;
	types["mlit"] = list;
	types["minm"] = stringVal;
	types["asgn"] = stringVal;
	types["asal"] = stringVal;
	types["asar"] = stringVal;
	types["mikd"] = byteVal;
	types["assp"] = intVal;
	types["assr"] = intVal;
	types["asst"] = intVal;
	types["astm"] = intVal;
	types["asai"] = longVal;
	types["miid"] = intVal;
	
	var lastUpdate = 0;

	function PlayStatusUpdate(tree) {

		this.album = "";
		this.title = "";
		this.artist = "";
		this.genre = "";
		this.id = 0;
		this.status = 0;
		this.revision = 0;
		
		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "caps":
				this.status = node.value;
				break;
			case "cmsr":
				this.revision = node.value;
				break;
			case "cann": this.title = node.value; break;
			case "cana": this.artist = node.value; break;
			case "canl": this.album = node.value; break;
			case "cang": this.genre = node.value; break;
			case "canp": this.id = node.value[3]; break;
			}
		}
	}

	function Playlist(tree) {

		this.tracks = new Array();
		
		var list = 0;
		
		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "mlcl":
				list = node;
				break;
			}
		}

		if (!list) return;

		for (child in list.children) {
			var node = list.children[child];
			switch (node.name) {
			case "mlit":
				this.tracks.push(new Track(node));
				break;
			}
		}
	}

	function Track(tree) {

		this.album = "";
		this.title = "";
		this.artist = "";
		this.genre = "";
		this.id = 0;
	
		for (child in tree.children) {
			var node = tree.children[child];
			switch (node.name) {
			case "asal": this.album = node.value; break;
			case "minm": this.title = node.value; break;
			case "asar": this.artist = node.value; break;
			case "asag": this.genre = node.value; break;
			case "miid": this.id = node.value; break;
			}
		}
	}

	function updateStatus(update) {

		if (update.status == 2) {
			document.getElementById("state").className = "stopped";

			document.getElementById("play").className = "";
			document.getElementById("pause").className = "hidden";
		}
		else if (update.status == 3) {
			document.getElementById("state").className = "paused";
			setText(document.getElementById("title"), update.title);
			setText(document.getElementById("artist"), update.artist);
			setText(document.getElementById("album"), update.album);
			setText(document.getElementById("genre"), update.genre);
			
			document.getElementById("play").className = "";
			document.getElementById("pause").className = "hidden";
		}
		else if (update.status == 4) {
			document.getElementById("state").className = "playing";
			setText(document.getElementById("title"), update.title);
			setText(document.getElementById("artist"), update.artist);
			setText(document.getElementById("album"), update.album);
			setText(document.getElementById("genre"), update.genre);

			document.getElementById("play").className = "hidden";
			document.getElementById("pause").className = "";
		}
	}

	function setText(node, text) {
		while (node.childNodes.length > 0) {
			node.removeChild(node.firstChild);
		}
		node.appendChild(document.createTextNode(text));
	}

	function updatePlaylist(playlist) {

		var list = document.getElementById("playlist");
		list.innerHTML="";

		var current = lastUpdate.id;
		
		for (i in playlist.tracks) {
			var track = playlist.tracks[i];

			var node = document.createElement("DIV");
			node.className = "track";
			
			node.appendChild(createNode("album", track.album));
			node.appendChild(createNode("title", track.title));
			node.appendChild(createNode("artist", track.artist));
			node.appendChild(createNode("genre", track.genre));
			node.appendChild(createNode("id", track.id));

			if (current && track.id == current) {
				node.className += " current";
				current = 0;

				while (list.childNodes.length > 2) {
					list.removeChild(list.childNodes[0]);
				}
			}

			list.appendChild(node);
		}
	}

	function createNode(type, value) {
		var node = document.createElement("DIV");
		node.className = type;
		node.appendChild(document.createTextNode(value));
		return node;
	}
	
	function registerControls() {
		document.getElementById("previous").onclick = function () { prev(); }
		document.getElementById("play").onclick = function () { play(); }
		document.getElementById("pause").onclick = function () { pause(); }
		document.getElementById("next").onclick = function () { next(); }

		document.getElementById("playlist").onclick = function (e) {
			var node = e.target;
			while (!node.className.match("track")) {
				node = node.parentNode;
				if (node == document.body) return;
			}
			var playlist = document.getElementById("playlist");
			var offset = -1;
			for (child in playlist.childNodes) {
				if (playlist.childNodes[child].className
						&& playlist.childNodes[child].className.match("current")) {
					offset = child;
				}
			}
			if (offset == -1) return;
			for (child in playlist.childNodes) {
				if (playlist.childNodes[child] == node) {
					jump(child-offset);
					break;
				}
			}
		}
		
		replacePrev();
		replacePause();
		replacePlay();
		replaceNext();
	}

	function replacePrev() {
		var prev = document.getElementById("previous");
		prev.removeChild(prev.firstChild);
		
		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 33, 30');
		svg.setAttribute('width', '33');
		svg.setAttribute('height', '30');
		
		var bar = document.createElementNS(ns,'path');
		bar.setAttribute('d','m 0,3 4,0 0,24 -4,0 z');
		bar.setAttribute('style','fill: #222;');
		svg.appendChild(bar);

		var la = document.createElementNS(ns,'path');
		la.setAttribute('d','m 7,15 10,11 0,-22 z');
		la.setAttribute('style','fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(la);

		var ra = document.createElementNS(ns,'path');
		ra.setAttribute('d','m 20,15 10,11 0,-22 z');
		ra.setAttribute('style','fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(ra);
		
		prev.appendChild(svg);
	}

	function replacePlay() {
		var play = document.getElementById("play");
		play.removeChild(play.firstChild);
		
		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 30, 30');
		svg.setAttribute('width', '30');
		svg.setAttribute('height', '30');
		
		var p = document.createElementNS(ns,'path');
		p.setAttribute('d','m 5,3 22,12 -22,12 z');
		p.setAttribute('style','fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(p);
		
		play.appendChild(svg);
	}

	function replacePause() {
		var pause = document.getElementById("pause");
		pause.removeChild(pause.firstChild);
		
		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 17, 30');
		svg.setAttribute('width', '30');
		svg.setAttribute('height', '30');
		
		var l = document.createElementNS(ns,'path');
		l.setAttribute('d','m 0,2 6,0 0,26 -6,0 z');
		l.setAttribute('style','fill: #222;');
		svg.appendChild(l);

		var r = document.createElementNS(ns,'path');
		r.setAttribute('d','m 11,2 6,0 0,26 -6,0 z');
		r.setAttribute('style','fill: #222;');
		svg.appendChild(r);
		
		pause.appendChild(svg);
	}

	function replaceNext() {
		var next = document.getElementById("next");
		next.removeChild(next.firstChild);
		
		var ns = 'http://www.w3.org/2000/svg';
		var svg = document.createElementNS(ns, 'svg');
		svg.setAttribute('viewPort', '0, 0, 33, 30');
		svg.setAttribute('width', '33');
		svg.setAttribute('height', '30');

		var la = document.createElementNS(ns,'path');
		la.setAttribute('d','m 1,4 10,11 -10,11 z');
		la.setAttribute('style','fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(la);

		var ra = document.createElementNS(ns,'path');
		ra.setAttribute('d','m 15,4 10,11 -10,11 z');
		ra.setAttribute('style','fill: #222;stroke: #222; stroke-width:0.2em;stroke-linejoin:round;');
		svg.appendChild(ra);

		var bar = document.createElementNS(ns,'path');
		bar.setAttribute('d','m 27,3 4,0 0,24 -4,0 z');
		bar.setAttribute('style','fill: #222;');
		svg.appendChild(bar);
		
		next.appendChild(svg);
	}
//]]>
</script>

<style type="text/css">
html, body {
	margin: 0;
}
body {
	font-family: "Chicago", "Geneva", sans-serif;
}
.track {
	border-bottom: solid 1px #ccc;
	padding: 1ex 1em;
	display: block;
}
.album,.artist,.title {
	display: block;
}
.album, .artist {
	color: #888;
	font-size: 0.7em;
}
.title {
	font-weight: bold;
}
.id {
	display: none;
}
.current {
	background-color: #eee;
}
#state {
	font-size: 120%;
	padding: 2ex 1em;
	padding-bottom: 2ex;
	border-bottom: solid 2px #ccc;
	overflow: auto;
}
#albumart {
	height: 10ex;
	float: left;
	margin-right: 1em;
}
#playlist {
	margin-bottom: 8ex;
}
#control {
	position: fixed;
	bottom: 0;
	height: 4ex;
	padding: 2ex 0;
	width: 100%;
	text-align: center;
	opacity: 0.8;
	background-color: #ccc;
}
#control div {
	display: inline;
}
#control .hidden {
	display: none;
}
#control #volume {
	display: none;
}
#play,#pause {
	padding: 2ex 3em;
}

</style>

</head>
<body onload="registerControls(); getPlaybackStatusUpdate();">
<div id="state">
<img id="albumart" src="" alt="" />
<div id="title" class="title"></div>
<div id="artist" class="artist"></div>
<div id="album" class="album"></div>
<div id="genre" class="genre"></div>
</div>
<div id="control">
<div id="previous">previous</div>
<div id="play">play</div>
<div id="pause">pause</div>
<div id="next">next</div>
<div id="volume">volume</div>
</div>
<div id="playlist">
</div>
</body>
</html>